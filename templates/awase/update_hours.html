{% extends 'base.html' %}
{% load static %}
{% load getsongdetail %}

{% block title %}{{calendar.title}}の集計時間を変更 | あわせのあわせ | Unplugged Message{% endblock %}
{% block extrastyle %}
{% endblock %}


{% block vuebody %}
<h3><a href="{% url 'awase:calendar' calendar.pk %}">{{ calendar.title }}</a>の集計時間を変更</h3>
<p class="mb-4">
    各日にちの中で日程調整したい時間帯を変更できます。<br>
    時間は24時間表記で、9時(AM9:00)～26時(翌AM2:00)まで1時間単位で指定できます。<br>
    また、期間内の任意の日を、「集計しない日」に設定することも出きます。
</p>
<awase-update-hours
  json-url="{% url 'awase:hours_update_json' calendar.pk %}"
></awase-update-hours>
<hr>
<a href="{% url 'awase:calendar' calendar.pk %}" class="btn btn-primary my-2">日程調整「{{ calendar.title }}」に戻る</a>
{% endblock %}

{% block body %}
<!-- 
<section id="app">
    <hr>
</section>

<a href="{% url 'awase:calendar' calendar.pk %}" class="btn btn-primary my-2">日程調整「{{ calendar.title }}」に戻る</a>

<script type="text/javascript">
const jsonURL = "{% url 'awase:hours_update_json' calendar.pk %}";



Vue.component('time-selector', {
    
    delimiters: ['[[', ']]'],
    template: `<select v-model="value" @change="eventUp" class="form-control col-3 d-inline">
                   <option
                        v-for="i in 18"
                        :value="i+8"
                        :disabled="!(minSafed <= i+8 && i+8 <= maxSafed)"
                        >
                            [[ i+8 ]]:00
                        </option>
               </select>`,


})


let app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
        jsonLoaded: false,
        isProcessError: false,
        errorMessage: '',
        isInAccess: false,
        timedata: {},
        selectedDate: {},
        start: null,
        end: null,
        beforePOSTRequest: {},
    },
    mounted: function(){  
        var request = new XMLHttpRequest();
        request.open('GET', jsonURL);
        request.responseType = 'json';
        request.send();
        request.onload = function(){
            let response = request.response;
            app.timedata = response;
            console.log(app.timedata);

            app.jsonLoaded = true;
        }
    },
    methods: {
        dayadd: function(e){
            let id = e.id;
            if (!(id in this.selectedDate)) {
                this.$set(this.selectedDate, id, e);
            }
        },
        dayremove: function(e){
            let id = e.id;
            if (id in this.selectedDate) {
                this.$delete(this.selectedDate, id);
            }
        },
        clear: function(){
            this.selectedDate = {};
        },
        timeChange: function(e){
            this[e.name] = e.value;
        },
        setTimeData: function(){
            if (this.start === null && this.end === null) {
                return false;
            }
            for (day in this.selectedDate) {
                let content = this.selectedDate[day];
                let key = this.dateToYYYYMMDD(content.date);
                if (this.start){
                    this.$set(this.timedata[key], 'start', this.start);
                }
                if (this.end) {
                    this.$set(this.timedata[key], 'end', this.end);
                }
                if (this.timedata[key].start > this.timedata[key].end) {
                    console.log('validation error');
                    if (this.start === null) {
                        this.$set(this.timedata[key], 'start', 9);
                    } else if (this.end === null) {
                        this.$set(this.timedata[key], 'end', 26);
                    } else {
                        this.$set(this.timedata[key], 'start', 9);
                        this.$set(this.timedata[key], 'end', 26);
                    }
                }
                this.$set(this.beforePOSTRequest, key, this.timedata[key]);
                this.$delete(this.selectedDate, day);
            }
            this.postMethod();
        },
        setNotCollectDay: function(){
            for (day in this.selectedDate) {
                let content = this.selectedDate[day];
                let key = this.dateToYYYYMMDD(content.date);

                this.$set(this.timedata[key], 'start', 9);
                this.$set(this.timedata[key], 'end', 9);

                this.$set(this.beforePOSTRequest, key, this.timedata[key]);
                this.$delete(this.selectedDate, day);
            }
            this.postMethod();
        },
        postMethod: function(){
            this.isInAccess = true;
            let data = {};
            let inProcess = [];
            let counter = 0;
            for (var key in this.beforePOSTRequest) {
                if (counter > 10) {break;}
                data[key] = this.beforePOSTRequest[key].start + '-' + this.beforePOSTRequest[key].end;
                inProcess.push(key);
                counter += 1;
            }

            axios.defaults.xsrfCookieName = 'csrftoken';
            axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
            axios.post(jsonURL, data)
                .then(function (response) {
                    console.log(response);
                    app.isProcessError = false;
                    for (var key of inProcess) {
                        app.$delete(app.beforePOSTRequest, key);
                    }

                    if (Object.keys(app.beforePOSTRequest).length > 0) {
                        app.postMethod();
                    } else {
                        app.isInAccess = false;
                    }
                })
                .catch(function (error) {
                    console.log(error);
                    app.isInAccess = false;
                    if (!error.response.status) {
                        console.log('network error');
                        app.isProcessError = true;
                        app.errorMessage = '通信に失敗しました。インターネットへの接続を確認し、再度送信ボタンを押してください。(Network Error)'
                    } else {
                        console.log('internal error');
                        app.isProcessError = true;
                        app.errorMessage = '処理に失敗しました。変更が保存されていない可能性があります。お手数ですが、開発者までご連絡ください。(' +
                                           error.response.status + ' ' + error.response.statusText + ')';
                    }
                });
        },
        dateToYYYYMMDD: function(date){
            return date.getFullYear() + '' + ('0'+ (date.getMonth()+1) ).slice(-2) + '' + ('0' + date.getDate()).slice(-2);
        }
    },
    computed: {
    },
    watch: {

    }
})

</script>
<style type="text/css">
.ceil{
    cursor: default;
}
.ceil.active{
    cursor: pointer;
}
.ceil.selected{
    background-color: #adddeb;
}

div.is-in-access{
    position: fixed;
    bottom: 0;
    right: 0;
    margin: 0 1rem;
    padding: 0.25rem;
}
</style> -->
{% endblock %}