{% extends 'base.html' %}
{% load static %}
{% load getsongdetail %}

{% block title %}{{ calendar.title }} に回答 | Unplugged Message{% endblock %}
{% block extrastyle %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src='https://unpkg.com/v-calendar'></script>
{% endblock %}


{% block body %}
<h3><a href="{% url 'awase:calendar' calendar.pk %}">{{ calendar.title }}</a> に回答</h3>


<section id="app" class="row my-3 border-top">
<nav id="input-nav" :class="{'active': isMenuOpen}" class="pt-3">
    <div id="calendar-wrap">
        <h5 class="px-3">日付を選択</h5>
        <v-calendar
        :first-day-of-week="2"
        is-expanded
        >
            <template slot='header-title' slot-scope='props'>
                [[props.yearLabel]]年[[props.monthLabel]]
            </template>
            <template slot='day-content' slot-scope='props'>
                <custom-day-content
                    :day="props.day"
                    :data="timedata[dateToYYYYMMDD(props.day.date)]"
                    :is-selected="dateToYYYYMMDD(props.day.date) == selectedDate"
                    @dayadd="dayadd"
                    ></custom-day-content>
            </template>
        </v-calendar>
    </div>
</nav>
<button @click="isMenuOpen = !isMenuOpen" id="menu-switch" :class="{'active': isMenuOpen}">メニュー</button>
<form id="input-form" class="pt-3">
    <h5 class="ml-5">[[YYYYMMDDToTitle]]</h5>
<input-forms></input-forms>
<br>
<br>
<br>
<br>
<br>
hoge
</form>

</section>



<script type="text/javascript">
const jsonURL = "{% url 'awase:hours_update_json' calendar.pk %}";

Vue.component('custom-day-content', {
    props: {
        day: {type: Object, required: true},
        data: {type: Object, required: false, default: () => {return{start: '', end: ''}},},
        isSelected: {type: Boolean, required: false}
    },
    delimiters: ['[[', ']]'],
    template: `<div
                  class="ceil text-center pt-1 pb-2"
                  @click="onclick"
                  :class="{active: isActive, selected: isSelected}"
                >
                   <h6 class="m-0 p-0" :style="addStyleTextColor(day.weekday)">[[day.day]]</h6>
                   <span class="small">[[displayHour]]</span>
               </div>`,
    methods: {
        onclick: function(){
            this.$emit('dayadd', this.day);
        },
        addStyleTextColor: function(weekday) {
            if (weekday === 1) {
                return {
                    color: "red"
                };
            } else if (weekday === 7) {
                return {
                    color: "#1669a8"
                };
            }
        }

    },
    computed: {
        displayHour: function(){
            let start = this.data.start;
            let end = this.data.end;
            if (!this.isActive) {
                return '-';
            } else if (start === end) {
                return '×';
            } else {
                return start + '-' + end;
            }
        },
        isActive: function(){
            return !(this.data.start === '' && this.data.end === '');
        }
    }
})

Vue.component('input-forms', {
    props: {
        start: {type: Number, required: false, default: 9},
        end: {type: Number, required: false, default: 26},
    },
    delimiters: ['[[', ']]'],
    template: `<div class="form_oneday_all">
                    <span class="mx-3">１日一括指定</span>
                    <button type="button" class="dayall" value="False">×</button>
                    <button type="button" class="dayall" value="True">○</button>
                </div>`,
})

Vue.component('input-one-row', {
    props: {
    },
    delimiters: ['[[', ']]'],
    template: `<div><input-forms></input-forms>
        <br>huga
        </div>`,
})

let app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
        isMenuOpen: false,
        jsonLoaded: false,
        isProcessError: false,
        errorMessage: '',
        isInAccess: false,
        timedata: {},
        selectedDate: '',
        beforePOSTRequest: {},
    },
    mounted: function(){
        var request = new XMLHttpRequest();
        request.open('GET', jsonURL);
        request.responseType = 'json';
        request.send();
        request.onload = function(){
            let response = request.response;
            app.timedata = response;
            console.log(app.timedata);

            app.jsonLoaded = true;

            let today = app.dateToYYYYMMDD(new Date());
            app.selectedDate = today;
            console.log(today);
            if (!(today in app.timedata)){
                // 範囲に入ってない時の処理
            }
        }
    },
    methods: {
        dayadd: function(e){
            app.selectedDate = app.dateToYYYYMMDD(e.date);
        },
        dateToYYYYMMDD: function(date){
            return date.getFullYear() + '' + ('0'+ (date.getMonth()+1) ).slice(-2) + '' + ('0' + date.getDate()).slice(-2);
        }
    },
    computed: {
        YYYYMMDDToTitle: function(){
            if (this.selectedDate == ''){
                return '';
            }
            let year = Number(this.selectedDate.slice(0,4))
            let month = Number(this.selectedDate.slice(4,6));
            let day = Number(this.selectedDate.slice(6,8));
            let date = new Date(year, month - 1, day);
            let jp_weekday = ['日','月','火','水','木','金','土'];
            return month + '月' + day + '日（' + jp_weekday[date.getDay()] + '）';
        }
    },
    watch: {
        //  selectedDate: function(){
        //      console.log(this.selectedDate);
        //  }
    }
})

</script>
<style type="text/css">
section#app{
    position: relative;
}
#menu-switch{
    position: absolute;
    display: block;
    width: 100px;
    height: 50px;
    top: 0;
    left: 0;
    overflow: visible;
    transition: .2s;
}
#menu-switch.active{
    left: 280px;
}
#input-nav{
    position: absolute;
    display: block;
    border: none;
    top: 0;
    left: 0;
    width: 0px;
    padding: 0;
    background-color: #fff;
    transition: .2s;
    overflow: hidden;
}
#input-nav.active{
    width: 280px;
    padding: 0 10px;
    border-right: 1px solid #aaa;
}
div#calendar-wrap{
    width: 260px;
}

#input-form{
    width: 100%;
}

@media screen and (min-width: 768px) {
#menu-switch{
    display: none;
}
#input-nav{
    position: absolute;
    width: 280px;
    top: 0;
    left: 0;
    padding: 0 10px;
    border-right: 1px solid #aaa;

}
#input-form{
    width: calc(100% - 280px);
    margin-left: 280px;
    padding: 1rem 10px;
}

}


/* Calendar内のcss */
.ceil{
    cursor: default;
}
.ceil.active{
    cursor: pointer;
}
.ceil.selected{
    background-color: #adddeb;
}


/* inputのcss */
.form_checks{
    display: block;
    position: relative;
    margin: 0;
    padding: 0;
    width: 100%;
    min-width: 300px;
    max-width: 600px;
    overflow-x: scroll;
    letter-spacing:-1em;
}
.form_checks *{
    letter-spacing:normal;
}
.form_one_check,
.form_oneday_all{
    display: inline-block;
    padding: 0.25rem 0;
    margin: 0;
    width: 50%;
    height: 42px;
    border: none;
    box-sizing: inherit;
}
.form_one_check:nth-of-type(4n),
.form_one_check:nth-of-type(4n+1){
    background-color: #f3f3f3;
}
.form_oneday_all{
    width: 100%;
    background-color: #ffffcc;
}
input[type="text"]{
    display: inline;
    width: 2.5rem;
    margin: 0 4px 0 2px;
    padding: 0;
}
input[type="radio"]{
    display: none;
}

input[type="radio"] + label,
.form_oneday_all button.dayall{
    display: inline-block;
    position: relative;
    width: 24%;
    max-width: 5rem;
    text-align: center;
    padding: 0rem;
    margin: 0;
    border-radius: 0.6rem;
    font-size: 1.4rem;
    line-height: 2rem;
    }
input[type="radio"][value="True"] + label,
.form_oneday_all button.dayall[value="True"]{
    border: 1px solid transparent;
    color: #4cd964;
}
input[type="radio"][value="True"]:checked + label,
.form_oneday_all button.dayall[value="True"]{
    background-color: #4cd964;
    color: #fff;
}

input[type="radio"][value="False"] + label,
.form_oneday_all button.dayall[value="False"]{
    border: 1px solid transparent;
    color: #ff3b30;
}
input[type="radio"][value="False"]:checked + label,
.form_oneday_all button.dayall[value="False"]{
    background-color: #ff3b30;
    color: #fff;
}
</style>
{% endblock %}